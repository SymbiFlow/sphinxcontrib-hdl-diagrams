language: minimal
dist: bionic

before_install:
    - make env

stages:
    - name:
        - Test
        - Build
        - Deploy

jobs:
    - stage: Tests
      name: "Test :skin: option"
      script:
        - source env/conda/bin/activate sphinxcontrib-verilog-diagrams
        - cd tests && python3 -m unittest test.TestSkins

    - stage: Tests
      name: "Test :yosys_script: option"
      script:
        - source env/conda/bin/activate sphinxcontrib-verilog-diagrams
        - cd tests && python3 -m unittest test.TestYosysScript

    - stage: Tests
      name: "Test verilog_diagram_yosys config variable"
      script:
        - source env/conda/bin/activate sphinxcontrib-verilog-diagrams
        - cd tests && python3 -m unittest test.TestYosysType

    - stage: Build
      name: "Build"
      script:
        - make build

    - stage: Deploy
      name: "PyPI"
      before_deploy:
        - make clean
        - make sphinxcontrib_verilog_diagrams/version.py
        - sudo ln -sf /usr/bin/python3 /usr/bin/python
      deploy:
        provider: pypi
        username: __token__
        distributions: sdist bdist_wheel
        skip_existing: true
        edge: true # opt in to dpl v2

    - stage: Deploy
      name: "Test HTMLs"
      before_deploy:
        - bash $TRAVIS_BUILD_DIR/.github/deploy_test_preview.sh
      deploy:
        - provider: pages
          skip_cleanup: true
          token: $GITHUB_PAGES_TOKEN
          local_dir: $TRAVIS_BUILD_DIR/tests/gh-pages
          on:
            branch: master
